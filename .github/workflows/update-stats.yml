name: Update Olympic Stats

on:
  schedule:
    # Run every 2 hours during Olympics (Feb 11-23)
    - cron: '0 */2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  update-stats:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        
      - name: Scrape and update stats
        run: |
          # Scrape player stats
          PLAYERS=$(curl -s -A "Mozilla/5.0" "https://www.quanthockey.com/olympics/en/seasons/olympics-players-stats.html" | \
            grep -oP '<tr class="(odd|even)[^"]*"[^>]*>[\s\S]*?</tr>' | head -10 | \
            sed 's/<[^>]*>//g' | tr -s ' ' | head -5)
          
          # Scrape goalie stats  
          GOALIES=$(curl -s -A "Mozilla/5.0" "https://www.quanthockey.com/olympics/en/seasons/olympics-goalies-stats.html" | \
            grep -oP '<tr class="(odd|even)[^"]*"[^>]*>[\s\S]*?</tr>' | head -20)
          
          # Use Node.js to properly parse and update JSON
          node << 'EOF'
          const fs = require('fs');
          const https = require('https');
          
          const headers = { 'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36' };
          
          function fetch(url) {
            return new Promise((resolve, reject) => {
              https.get(url, { headers }, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => resolve(data));
              }).on('error', reject);
            });
          }
          
          async function main() {
            const data = JSON.parse(fs.readFileSync('data.json', 'utf8'));
            
            // Fetch players
            const playersHtml = await fetch('https://www.quanthockey.com/olympics/en/seasons/olympics-players-stats.html');
            const playerRows = playersHtml.match(/<tr class="(odd|even)[^"]*"[^>]*>[\s\S]*?<\/tr>/g) || [];
            
            const scorers = playerRows.slice(0, 10).map(row => {
              const text = row.replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();
              const parts = text.split(' ');
              return {
                name: parts[1] + ' ' + parts[2],
                team: parts[3],
                gp: parts[5],
                goals: parts[6],
                assists: parts[7],
                points: parseInt(parts[8])
              };
            }).sort((a, b) => b.points - a.points).slice(0, 5).map((p, i) => ({
              rank: (i + 1) + '.',
              name: p.name,
              team: p.team,
              gp: p.gp,
              goals: p.goals,
              assists: p.assists,
              points: String(p.points)
            }));
            
            // Fetch goalies
            const goaliesHtml = await fetch('https://www.quanthockey.com/olympics/en/seasons/olympics-goalies-stats.html');
            const goalieRows = goaliesHtml.match(/<tr class="(odd|even)[^"]*"[^>]*>[\s\S]*?<\/tr>/g) || [];
            
            const goalies = goalieRows.slice(0, 20).map(row => {
              const text = row.replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();
              const parts = text.split(' ');
              return {
                name: parts[1] + ' ' + parts[2],
                team: parts[3],
                gp: parts[5],
                gaa: parts[6],
                svp: parseFloat(parts[7]),
                wins: parts[8]
              };
            }).sort((a, b) => b.svp - a.svp).slice(0, 5).map((g, i) => ({
              rank: (i + 1) + '.',
              name: g.name,
              team: g.team,
              gp: g.gp,
              wins: g.wins,
              gaa: g.gaa,
              svp: '.' + Math.round(g.svp * 1000).toString().padStart(3, '0')
            }));
            
            data.storedESPNStats = {
              scorers,
              goalies,
              lastFetch: new Date().toISOString()
            };
            
            fs.writeFileSync('data.json', JSON.stringify(data, null, 2));
            console.log('Updated stats:', { scorers: scorers.length, goalies: goalies.length });
          }
          
          main().catch(console.error);
          EOF
          
      - name: Commit and push
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add data.json
          git diff --staged --quiet || (git commit -m "Auto-update stats $(date -u +%Y-%m-%dT%H:%M:%SZ)" && git push)
